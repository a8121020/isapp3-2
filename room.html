<!DOCTYPE html>

<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

    <script type="text/javascript" src="lib/jquery.min.js"></script>
    <script type="text/javascript" src="lib/osql.js"></script>

    <script>
        osql.requireLogin();

        var me;
        var roomId = osql.getParam('roomId');//ルームId
        var userId = sessionStorage.getItem('userid');//Userメールアドレス

        $(document).ready(async function () {
            me = await osql.getMe();

            document.getElementById('lastname').innerHTML = me.lname;
            document.getElementById('firstname').innerHTML = me.fname;

            var sql = `select name from Rooms where id ='${roomId}'`;
            var RoomName = await osql.connect(sql);
            document.getElementById('roomname').innerHTML = RoomName[0].name;

            var InsertUser = `insert into Participate (userId,roomId) values('${userId}','${roomId}')`;
            await osql.connect(InsertUser);

            DisplayUsers();
            setInterval(DisplayTopic, 2000)
        });

        async function DisplayUsers(){
            var sql = `select fname,lname from Participate inner join Users on Users.id = Participate.userId;`;
            var objects = await osql.connect(sql);
            console.log(objects);
            var html = '';
            html = html + '<table border="1">';
            for(var i=0; i<objects.length; i++){
                html = html + '<tr>';
                var object = objects[i];
                html = html + `<td>${object.fname}${object.lname}</td>`;
                html = html + '</tr>';
            }
            html = html + '</table>';
            document.getElementById('UserList').innerHTML = html;
        }

        async function DecideTopic(){
            var TopicName = document.getElementById('TopicName').value;
            var sql = `update Rooms set topic ='${TopicName}'  where id = '${roomId}'`;
            osql.connect(sql);

        }

        async function DisplayTopic(){
            var TopicSQL = `select topic from Rooms where id = "${roomId}"`;
            var objects = await osql.connect(TopicSQL);
            var topic = objects[0].topic;
            document.getElementById('DisplayTopic').innerHTML = topic;
        }

        async function LogOut(){
            var ans = window.confirm("退出しますか？");
            var sql = `select count(*) from Participate`;
            var objects = await osql.connect(sql);
            console.log(objects);
            var count = 'count(*)';
            if(ans==true && objects[0].count ==1){
                var sql = `delete from Participate where id = "${userId}" update Rooms set topic = "null"`;
                osql.connect(sql);
                location.href="robby.html";
            }else if (ans == true){
                osql.connect(sql);
                location.href="robby.html";
            }
        }
    </script>

</head>

<body>
    <h1 id="roomname"></h1>
    <div style="text-align: right;">
        ようこそ<span id="lastname"></span> <span id="firstname"></span>さん
        <a href="index.html">top</a>
        <button onclick="LogOut()">退出する</button>
    </div>

    <hr>
   <ol>
    <li>「Start」ボタンを押し、ゲーム開始。</li>
   </ol>

   <ul>
    <li>退出する時は、右上の「退出」ボタンを押してください。</li>
   </ul>

    <hr>
    <input id = "TopicName" type="text">
    <button onclick="DecideTopic()">お題を決定</button>
    <h3>お題:<span id="DisplayTopic"></span></h3>
    <hr>
    <h3>現在参加している人：<span id="UserList"></span></h3>
    <hr>
   <h3>みんなの回答</h3>
   <p id="DisplayTable"></p>
</body>

</html>