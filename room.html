<!DOCTYPE html>

<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

    <script type="text/javascript" src="lib/jquery.min.js"></script>
    <script type="text/javascript" src="lib/osql.js"></script>

    <script>
        osql.requireLogin();

        var me;
        var roomId = osql.getParam('roomId');
        sessionStorage.setItem('roomId', roomId);
        var userId = sessionStorage.getItem('userid');
        var order;
        var userList = [];

        $(document).ready(async function () {

            me = await osql.getMe();

            document.getElementById('lastname').innerHTML = me.lname;
            document.getElementById('firstname').innerHTML = me.fname;

            var sql2 = `select name from Rooms where id ='${roomId}'`;
            var RoomName = await osql.connect(sql2);
            document.getElementById('roomname').innerHTML = RoomName[0].name;

            var CountSql = `select count(*) from Participate where roomId = ${roomId}`;
            var Usercount = await osql.connect(CountSql);

            var InsertUser = `insert into Participate (userId,roomId) values('${userId}','${roomId}')`;
            await osql.connect(InsertUser);

            StartOrNo();
            DisplayUsers();
            setInterval(DisplayTopic, 2000)
        });

        async function DisplayUsers() {
            var sql = `select fname,lname from Participate inner join Users on Users.id = Participate.userId where roomId = "${roomId}";`;
            /*Usersテーブルに登録されているIdとParticipateテーブルに登録されているIdを照合して、一致したら、その人の下の名前
            を表示する*/
            var objects = await osql.connect(sql);
            var html = '';
            html = html + '<table border="1">';
            for (var i = 0; i < objects.length; i++) {
                //var Iplus = i + 1;
                html = html + '<tr>';
                var object = objects[i];
                html = html + `<td>${object.fname}${object.lname}</td>`;
                html = html + '</tr>';
                //console.log(Iplus);
            }
            order = objects.length;
            html = html + '</table>';
            document.getElementById('UserList').innerHTML = html;
        }

        async function DecideTopic() {
            var TopicName = document.getElementById('TopicName').value;
            var sql = `update Rooms set topic ='${TopicName}'  where id = '${roomId}'`;
            //update Rooms set status = 'まだ開始されていない' where id = ${roomId};
            osql.connect(sql);

        }

        async function DisplayTopic() {
            var TopicSQL = `select topic from Rooms where id = "${roomId}"`;
            var objects = await osql.connect(TopicSQL);
            var topic = objects[0].topic;
            document.getElementById('DisplayTopic').innerHTML = topic;
        }

        async function LogOut() {
            var ans = window.confirm("退出しますか？");
            var sql = `select count(*) from Participate`;
            var objects = await osql.connect(sql);
            var count = 'count(*)';
            var objects2 = objects[0][count]
            if (ans == true && objects2 == 1) {
                var sql = `delete from Participate where userId = "${userId}"; 
                            update Rooms set topic = "null" where name = "${roomId}";`;
                osql.connect(sql);
                location.href = "robby.html";
            } else if (ans == true) {
                osql.connect(sql);
                location.href = "robby.html"
            }
        }

        async function Start() {
            var button = document.getElementById('button');
            button.style.display = "none";
            document.getElementById('recent').innerHTML = "スタートしました"
            var sql = `update Rooms set status = '開始中' where id = "${roomId}"`;
            osql.connect(sql);
            var sql2 = `select fname,lname, userId from Participate inner join Users on Users.id = Participate.userId where roomId = "${roomId}";`;
            var who = await osql.connect(sql2);
            console.log(who);

            for (var i = 0; i < who.length; i++) {
                var object = who[i];
                userList.push(object.userId);
            }
            console.log(userList);
            //console.log(Math.floor(Math.random() * order + 1))

        }

        async function StartOrNo() {
            var sql = `select status from Rooms where id = "${roomId}"`;
            var StartOr = await osql.connect(sql);
            var status = StartOr[0].status;
            var CountSql = `select count(*) from Participate where roomId = ${roomId}`;
            var Usercount = await osql.connect(CountSql);
            //console.log(Usercount);
            var moji = "count(*)"
            var count = Usercount[0][moji];
            //console.log(count);
            //count = CountSql[0].moji;
            if (status == "開始中") {
                location.href = "CantEnter.html";
            }
        }

    </script>

</head>

<body>
    <h1 id="roomname"></h1>
    <div style="text-align: right;">
        ようこそ<span id="lastname"></span> <span id="firstname"></span>さん
        <a href="index.html">top</a>
        <button onclick="LogOut()">退出する</button>
    </div>

    <hr>
    <ol>
        <li>「Start」ボタンを押し、ゲーム開始。</li>
    </ol>

    <ul>
        <li>退出する時は、右上の「退出」ボタンを押すか、前のページに戻ってください。</li>
    </ul>

    <hr>
    <input id="TopicName" type="text">
    <button onclick="DecideTopic()">お題を決定</button>
    <h3>お題:<span id="DisplayTopic"></span></h3>
    <hr>
    <h3>現在参加している人：<span id="UserList"></span></h3>
    <hr>
    <button onclick="Start()" id="button">スタート</button>
    <p>現状：<span id="recent"></span></p>
    <p id="turn"></p>
    <h3>みんなの回答</h3>
    <p id="DisplayTable"></p>
</body>

</html>